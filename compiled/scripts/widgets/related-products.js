define(["modules/jquery-mozu","underscore","modules/api","modules/backbone-mozu","modules/models-product","hyprlivecontext"],function(e,t,r,o,a,i){var n=i.locals.siteContext,s=n.cdnPrefix,c=s.substring(s.lastIndexOf("-")+1),d=s+"/cms/"+c+"/files",u=function(e,o,a){var i=t.map(o,function(e){return"ProductCode eq "+e}).join(" or "),n="";switch(e){case"product":n=r.get("search",{filter:i});break;case"cart":n=r.get("search",{filter:i,pageSize:a})}return n},l=function(e){return!!e},p=require.mozuData("pagecontext");e(document).ready(function(){var r=[];switch(p.pageType){case"product":r.push(require.mozuData("product"));break;case"cart":var n=require.mozuData("cart").items;e.each(n,function(e,t){r.push(t.product)})}e("[data-mz-related-products]").each(function(n,s){s=e(s);for(var c=s.data("mzRelatedProducts"),m=c.attributeId||"tenant~product-crosssell",h=c.template||"modules/product/product-list-carousel",g=c.title,f=c.count||5,v=[],b=o.MozuView.extend({templateName:h,selectSwatchOption:function(t){var r=e(t.currentTarget).data("mz-swatch-color").toLowerCase(),o=e(t.currentTarget).data("mz-product-code"),a=i.locals.themeSettings.listProductImageWidth,n=(i.locals.themeSettings.listProductImageHeight,d+"/"+o+"_"+r+".jpg?maxWidth="+a);e(t.target).parents(".product-code").find(".image").attr("src",n)}}),x=0;x<r.length;x++){var w=r[x];if(w&&w.properties)for(var z=0;z<w.properties.length;z++)if(w.properties[z].attributeFQN==m){var C=t.pluck(w.properties[z].values,"value");v=v.concat(e.grep(C||[],l))}}return v&&v.length?(u(p.pageType,v,f).then(function(r){t.each(r.data.items,function(e){var r=[];if(e.options)for(var o=0;o<e.options.length;o++)if("tenant~COLOR"==e.options[o].attributeFQN){for(var a=0;a<e.options[o].values.length;a++){var n=e.options[o].values[a].stringValue.trim().replace(/ /g,"_").toLowerCase(),s=i.locals.themeSettings.listProductSwatchIconSize,c=d+"/"+e.productCode+"_"+n+"_sw.jpg?maxWidth="+s;r.push({color:n,swatchIconPath:c,productCode:e.productCode})}e.options[o].availableColors=t.uniq(r,"color")}});var o=new a.ProductCollection(r.data),n=new b({model:o,el:s});n.render(),n.model.attributes.items.length>1&&"modules/product/product-list-gorsuch"==h&&e(".bxslider").bxSlider({minSlides:2,maxSlides:4,slideWidth:270,slideMargin:20,nextText:'<i class="fa fa-angle-right" aria-hidden="true"></i>',prevText:'<i class="fa fa-angle-left" aria-hidden="true"></i>',responsive:!0,speed:0,infiniteLoop:!1,hideControlOnEnd:!0}),n.model.attributes.items.length>0&&s.prepend("<h3><span>"+g+"</span></h3>")}),void 0):(p.isEditMode&&s.html("<b>tbd preview content</b>"),void 0)})})});