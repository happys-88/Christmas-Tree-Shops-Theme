define(["modules/jquery-mozu","hyprlive","hyprlivecontext","underscore","modules/api","modules/backbone-mozu","modules/models-product"],function($,Hypr,HyprLiveContext,_,api,Backbone,ProductModels){var instance,init=function(options){var _options=options||{},_products={},getRTIOptions=function(){return _options},getProducts=function(){return _products},setRTIOptions=function(e){_options=e},setProducts=function(e){_products=e},getCookie=function(e){for(var t=e+"=",r=decodeURIComponent(document.cookie),n=r.split(";"),o=0;o<n.length;o++){for(var u=n[o];" "==u.charAt(0);)u=u.substring(1);if(0===u.indexOf(t))return u.substring(t.length,u.length)}return""},buildUrl=function(){var firstPart="//"+getRTIOptions().customerId+"-"+getRTIOptions().customerCode+".baynote.net/recs/1/"+getRTIOptions().customerId+"_"+getRTIOptions().customerCode+"?",requiredParams="&attrs=Price&attrs=ProductId&attrs=ThumbUrl&attrs=Title&attrs=url&attrs=ProductCode",userIdQuery="&userId="+getCookie("bn_u"),bnExtUserIdQuery="&User.bnExtUserId="+require.mozuData("user").userId,source=window.location.href;0===source.indexOf("http://")&&(source="https://"+source.slice(7));var sourceQuery="&source="+source,tenantIdQuery="",siteIdQuery="";getRTIOptions().includeTenantId&&(tenantIdQuery+="&tenantId="+require.mozuData("sitecontext").tenantId),getRTIOptions().includeSiteId&&(siteIdQuery+="&siteId="+require.mozuData("sitecontext").siteId);var pageDependentSection="";if("Home"==getRTIOptions().pageType);else if("ProductDetail"==getRTIOptions().pageType){var product=require.mozuData("product");bnProductId=product.productCode,pageDependentSection+="&productId="+bnProductId}else if("Cart"==getRTIOptions().pageType){var cart=require.mozuData("cart");if(cart.isEmpty)$(".cartRelated.recommended-product-container").not("#global-cart-rti .cartRelated.recommended-product-container").hide();else for(var i=0;i<cart.items.length;i++){var productId=cart.items[i].product.productCode,productQuery="&productId="+productId;pageDependentSection+=productQuery}}var inject="";if(getRTIOptions().jsInject)try{eval(getRTIOptions().jsInject)}catch(e){}else inject="&query=&Override=&Product.Override=";var url=firstPart+requiredParams+userIdQuery+bnExtUserIdQuery+sourceQuery+pageDependentSection+tenantIdQuery+siteIdQuery+inject+"&format=json";return url},fetchData=function(e){return $.get(buildUrl(),e)},parseProducts=function(e){var t=[];_.each(e.widgetResults,function(e){var r=e.displayName,n=e.placeholderName,o="",u=e.slotResults.filter(function(e){return e.url}),i=[];_.each(u,function(t){var r=[];_.each(t.attrs,function(e){r[e.name]=e.values[0]}),r.rank=t.rank,r.slot=t.slot||"",r.widgetId=e.id||"",i.push(r)}),0===i.length&&(o="There were no products configured for that placeholder name."),t.push({displayName:r,placeholderName:n,productList:i,editModeMessage:o})});var r=e.trackingData;return t.bnData=r,t};return{getProductData:function(e){getProducts().length>0?e(getProducts()):fetchData(function(t){setProducts(parseProducts(t)),e(getProducts())})}}};return{getInstance:function(e){return instance||(instance=init(e)),instance}}});